<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Old Texas Dude | The Vault</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js"></script>
</head>
<body id="personal-identity">
    <div class="terminal-overlay"></div>
    <div class="container">
        <header>
            <div class="warning-banner" style="text-align: center; margin-bottom: 20px;">
                <span class="blink" style="font-weight: bold; color: var(--accent);">!! WARNING: !!</span><br>
                <span style="font-size: 0.85em;">UNFILTERED OPINIONS AHEAD</span>
                <div style="margin-top:15px;">
                    <button id="theme-toggle" class="submit-btn" style="font-size:0.75em;">VISUAL_MODE</button>
                </div>
            </div>
        </header>

        <section class="hero-container">
            <img src="telescope2.png" alt="The Watch Tower">
            <div class="hero-text-block">
                <h1 class="main-title"><span class="typewriter">The Watch Tower</span></h1>
                <span class="by-line">by</span>
                <h1 class="main-title"><span class="typewriter delay-type">Old Texas Dude&trade;</span></h1>
            </div>
        </section>

        <nav class="vault-nav-container">
            <div class="secondary-filters">
                <button id="btn-chow" onclick="loadLogs('chow', false, this)" class="submit-btn">CHOW</button>
                <button id="btn-coord" onclick="loadLogs('coord', false, this)" class="submit-btn">COORD</button>
                <button id="btn-gear" onclick="loadLogs('gear', false, this)" class="submit-btn">GEAR</button>
                <button id="btn-system_logs" onclick="loadLogs('system_logs', false, this)" class="submit-btn">SYSTEM_LOGS</button>
            </div>
        </nav>

        <main class="vault-layout">
            <aside class="log-directory">
                <button id="re-scan-btn" onclick="runGlobalScan()" class="submit-btn" style="width:100%; margin-bottom:20px; color:var(--secondary); border-color:var(--secondary);">RESCAN</button>
                <h3>> LOG_DIRECTORY</h3>
                <ul id="log-list" class="file-list"><li>[ INITIALIZING_SCAN... ]</li></ul>
            </aside>

            <section class="log-display">
                <article id="content" class="blog-post">
                    <div id="startup-message" style="text-align: center; padding: 40px;">
                        <h2 class="force-blue">> SYSTEM_READY</h2>
                        <p style="font-size: 0.8rem; opacity: 0.7;">SELECT A DATA_CHANNEL OR SCAN FOR UPDATES.</p>
                    </div>
                </article>
                <div class="comment-module" style="margin-top:40px; border-top:1px solid var(--border); padding-top:20px;">
                    <script src="https://utteranc.es/client.js" repo="kdbush64-create/otd-vault" issue-term="pathname" theme="github-dark" crossorigin="anonymous" async></script>
                </div>
            </section>
        </main>

        <div class="surveillance-wrapper">
            <h3>> VISUAL_UPLINK</h3>
            <div style="font-size:0.7rem; margin-bottom:10px;"><span class="blink">‚óè REC</span> <span id="stardate"></span></div>
            <div class="feed-container">
                <behold-widget feed-id="9Bgo9cQPytudmTM356WP"></behold-widget>
            </div>
        </div>

        <footer>
            <p class="footer-tag blink">PERSONAL_THOUGHTS_V1.5 // NEON_MODULE_STABLE</p>
        </footer>
    </div>

    <script>
        const repo = "kdbush64-create/otd-vault";

        function clearStage(message = "CHANNEL_SELECTED") {
            const content = document.getElementById('content');
            content.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <h2 class="force-blue">> ${message}</h2>
                    <p style="font-size: 0.8rem; opacity: 0.7;">INITIALIZING DATA STREAM...</p>
                </div>`;
        }

        function applyBlueBranding(container) {
            const elements = container.querySelectorAll('p, li, div, strong, b');
            elements.forEach(el => {
                let html = el.innerHTML;
                if (html.includes('**')) {
                    el.innerHTML = html.replace(/\*\*(.*?)\*\*/g, '<span class="force-blue">$1</span>');
                }
            });
        }

        async function loadPost(path) {
            const content = document.getElementById('content');
            content.innerHTML = "<p class='blink' style='color:var(--accent)'>EXTRACTING_DATA_STREAM...</p>";
            try {
                const r = await fetch(`https://raw.githubusercontent.com/${repo}/main/${path}?t=${Date.now()}`);
                let txt = await r.text();
                if (txt.startsWith('---')) txt = txt.split('---').slice(2).join('---').trim();
                
                marked.setOptions({ gfm: true, breaks: true });
                content.innerHTML = `<div class="blog-post-body">${marked.parse(txt)}</div>`;
                
                applyBlueBranding(content);
                setTimeout(() => applyBlueBranding(content), 150);
                // SCROLL_TO_TOP REMOVED TO PREVENT JUMPING
            } catch (e) { 
                content.innerHTML = "<p class='force-blue'>[!] ERROR: DATA_LINK_SEVERED</p>"; 
            }
        }

        async function loadLogs(folder, auto = false, btn = null) {
            const list = document.getElementById('log-list');
            clearStage(`${folder.toUpperCase()}_CHANNEL`);
            document.querySelectorAll('.submit-btn').forEach(b => b.classList.remove('active'));
            if (btn) btn.classList.add('active');
            
            list.innerHTML = "<li>[ SCANNING_CHANNEL... ]</li>";
            try {
                const r = await fetch(`https://api.github.com/repos/${repo}/contents/${folder}?t=${Date.now()}`);
                const files = await r.json();
                list.innerHTML = "";
                
                files.filter(f => f.name.endsWith('.md')).sort((a,b) => b.name.localeCompare(a.name)).forEach(f => {
                    const li = document.createElement('li');
                    let name = f.name.replace('.md', '').toUpperCase().replace(/-/g, ' ');
                    li.innerHTML = `<a href="javascript:void(0)" onclick="loadPost('${f.path}')" class="log-link">> ${name}</a>`;
                    list.appendChild(li);
                });
            } catch (e) { list.innerHTML = "<li>[ SCAN_FAILED ]</li>"; }
        }

        async function runGlobalScan() {
            const list = document.getElementById('log-list');
            clearStage("SYSTEM_READY");
            list.innerHTML = '<li>[ GLOBAL_SCAN_ACTIVE... ]</li>';
            const folders = ['chow', 'coord', 'gear', 'system_logs'];
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
            let recentFiles = [];

            for (const fld of folders) {
                try {
                    const r = await fetch(`https://api.github.com/repos/${repo}/contents/${fld}?t=${Date.now()}`);
                    const data = await r.json();
                    if (Array.isArray(data)) {
                        data.forEach(file => {
                            if (file.name.endsWith('.md')) {
                                const match = file.name.match(/\d{4}-\d{2}-\d{2}/);
                                if (match && new Date(match[0]) >= sevenDaysAgo) {
                                    recentFiles.push(file);
                                }
                            }
                        });
                    }
                } catch (err) {}
            }

            if (recentFiles.length > 0) {
                list.innerHTML = '';
                recentFiles.sort((a, b) => b.name.localeCompare(a.name));
                recentFiles.forEach(f => {
                    const li = document.createElement('li');
                    let displayName = f.name.replace('.md', '').toUpperCase().replace(/-/g, ' ');
                    li.innerHTML = `<span class="blink" style="color:#ff0000; font-size:0.7em; font-weight:bold;">[NEW] </span><a href="javascript:void(0)" onclick="loadPost('${f.path}')" class="log-link">> ${displayName}</a>`;
                    list.appendChild(li);
                });
            } else {
                list.innerHTML = '<li>[ NO_RECENT_ACTIVITY ]</li>';
            }
        }

        document.getElementById('theme-toggle').addEventListener('click', () => {
            const current = document.documentElement.getAttribute('data-theme');
            const target = current === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', target);
            localStorage.setItem('theme', target);
        });

        setInterval(() => { 
            const clock = document.getElementById('stardate');
            if(clock) clock.innerText = new Date().toLocaleTimeString(); 
        }, 1000);

        window.onload = () => {
            if(localStorage.getItem('theme') === 'light') document.documentElement.setAttribute('data-theme', 'light');
            runGlobalScan();
        };
    </script>
    <script type="module" src="https://w.behold.so/widget.js"></script>
</body>
</html>
