<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Old Texas Dude | The Vault</title>
    
    <meta name="description" content="The Culinary and Technical Vault of Old Texas Dude: Featuring personal heritage recipes, culinary destinations, and field reports on gear and travel coordinates.">
    <meta name="keywords" content="Old Texas Dude, Product Evaluations, Independent Reviews, Travel Destinations, Heritage Recipes, Field Reports">
    <meta name="author" content="Old Texas Dude">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">

    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js"></script>
</head>
<body id="personal-identity">
    <div class="terminal-overlay"></div>
    <div class="container">
        <header>
            <div class="warning-banner" style="text-align: center; margin-bottom: 20px;">
                <span class="blink" style="font-weight: bold; color: var(--accent);">!! WARNING: !!</span><br>
                <span style="font-size: 0.85em;">UNFILTERED OPINIONS AHEAD</span>
                <div style="margin-top:15px;">
                    <button id="theme-toggle" class="submit-btn" style="font-size:0.75em;">VISUAL_MODE</button>
                </div>
            </div>
        </header>

        <section class="hero-container">
            <div class="hero-text-block">
                <h1 class="main-title"><span class="typewriter">The Watch Tower</span></h1>
                <span class="by-line">by</span>
                <h1 class="main-title"><span class="typewriter delay-type">Old Texas Dude&trade;</span></h1>
            </div>
            <img src="telescope2.png" alt="The Watch Tower">
        </section>

        <nav class="vault-nav-container">
            <div class="primary-nav" style="margin-bottom: 15px; width: 100%;">
                <button id="btn-about" onclick="loadLogs('about', false, this)" class="submit-btn" style="width: 100%; padding: 12px; border-color: var(--accent); color: var(--accent); font-weight: bold; font-size: 1rem;">
                    ABOUT: OLD TEXAS DUDE
                </button>
            </div>

            <div class="secondary-filters">
                <button id="btn-dispatch" onclick="loadLogs('dispatch', false, this)" class="submit-btn">THE DISPATCH</button>
                <button id="btn-transit" onclick="loadLogs('coord', false, this)" class="submit-btn">TRANSIT</button>
                <button id="btn-gear" onclick="loadLogs('gear', false, this)" class="submit-btn">GEAR</button>
                <button id="btn-coord" onclick="loadLogs('coord', false, this)" class="submit-btn">COORD</button>
                <button id="btn-table" onclick="loadLogs('table', false, this)" class="submit-btn">THE TABLE</button>
            </div>
        </nav>

        <main class="vault-layout">
            <aside id="sidebar" class="log-directory">
                <button id="re-scan-btn" onclick="runGlobalScan()" class="submit-btn" style="width:100%; margin-bottom:20px; color:var(--secondary); border-color:var(--secondary);">RESCAN</button>
                <h3>> LOG_DIRECTORY</h3>
                <ul id="log-list" class="file-list"><li>[ INITIALIZING_SCAN... ]</li></ul>
            </aside>

            <section class="log-display">
                <article id="content" class="blog-post">
                    </article>
                <div id="comment-wrapper" class="comment-module" style="display:none; margin-top:40px; border-top:1px solid var(--border); padding-top:20px;">
                    <script src="https://utteranc.es/client.js" repo="kdbush64-create/otd-vault" issue-term="pathname" theme="github-dark" crossorigin="anonymous" async></script>
                </div>
            </section>
        </main>

        <footer>
            <div style="text-align:center; margin-bottom:10px; font-size:0.7rem; color:var(--secondary);">
                SYSTEM_TIME: <span id="stardate"></span>
            </div>
            <p class="footer-tag blink">PERSONAL_THOUGHTS_V1.6.2 // DEEP_LINK_ENABLED</p>
        </footer>
    </div>

    <script>
        const repo = "kdbush64-create/otd-vault";
        const WORKER_URL = 'https://vault-mail-bot.kdbush64.workers.dev';

        function isNew(filename) {
            const dateMatch = filename.match(/^(\d{4})[_-](\d{2})[_-](\d{2})/);
            if (!dateMatch) return false;
            const postDate = new Date(`${dateMatch[1]}-${dateMatch[2]}-${dateMatch[3]}`);
            const now = new Date();
            const diffInDays = (now - postDate) / (1000 * 60 * 60 * 24);
            return diffInDays >= 0 && diffInDays <= 7;
        }

        function clearStage(message = "SYSTEM_READY", instruction = "SELECT A DATA_CHANNEL OR SCAN FOR UPDATES.") {
            const content = document.getElementById('content');
            content.innerHTML = `
                <div style="text-align: center; padding: 60px 20px;">
                    <h2 class="force-blue" style="letter-spacing: 2px;">> ${message}</h2>
                    <p class="blink" style="font-size: 0.85rem; color: #00d4ff; text-shadow: 0 0 8px rgba(0, 212, 255, 0.6); margin-bottom: 25px; font-family: monospace;">
                        [ INITIALIZING_DATA_STREAM... ]
                    </p>
                    <div style="width: 40px; height: 2px; background: var(--secondary); margin: 0 auto; opacity: 0.3;"></div>
                    <p class="instruction-text">${instruction}</p>
                </div>`;
        }

        function applyBlueBranding(container) {
            const elements = container.querySelectorAll('p, li, div, h1, h2, h3, h4, strong, b');
            elements.forEach(el => {
                let html = el.innerHTML;
                if (html.includes('**')) {
                    el.innerHTML = html.replace(/\*\*(.*?)\*\*/g, '<span class="force-blue">$1</span>');
                }
            });

            const links = container.querySelectorAll('a');
            links.forEach(link => {
                link.style.color = "#00d4ff"; 
                link.style.textDecoration = "underline";
                link.classList.add('v64-link'); 
            });
        }

        async function handleFormSubmit(event) {
            event.preventDefault();
            const form = event.target;
            const btn = form.querySelector('button');
            btn.innerText = "[ SENDING... ]";
            btn.disabled = true;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            try {
                const response = await fetch(WORKER_URL, {
                    method: 'POST',
                    mode: 'cors', 
                    headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (response.ok) {
                    form.innerHTML = `<h2 class="force-blue">> TRANSMISSION_SUCCESS</h2><p>The Vault has received your data.</p>`;
                } else { throw new Error('Line Busy'); }
            } catch (err) {
                btn.innerText = "[ ERROR_RETRY ]";
                btn.disabled = false;
                alert("Critical Error: Communication Link Failed.");
            }
        }

        async function loadPost(path) {
            const content = document.getElementById('content');
            const commentWrapper = document.getElementById('comment-wrapper');
            content.innerHTML = "<p class='blink' style='color:var(--accent)'>EXTRACTING_DATA_STREAM...</p>";
            try {
                const r = await fetch(`https://raw.githubusercontent.com/${repo}/main/${path}?t=${Date.now()}`);
                let txt = await r.text();
                commentWrapper.style.display = path.toLowerCase().includes('about/') ? 'none' : 'block';
                let cleanName = path.split('/').pop().replace('.md', '').toUpperCase().replace(/-/g, ' ').replace(/_/g, ' ');
                document.title = `${cleanName} | OTD Vault`;
                if (txt.startsWith('---')) { txt = txt.split('---').slice(2).join('---').trim(); }
                marked.setOptions({ gfm: true, breaks: true });
                const isAbout = path.toLowerCase().includes('the-man') || path.toLowerCase().includes('the_man');
                content.innerHTML = `
                    <div class="blog-post-body">
                        <div>${marked.parse(txt)}</div>
                        ${isAbout ? `
                            <div id="contact-terminal" style="margin-top:40px; border:1px solid var(--accent); padding:20px; background: rgba(0,255,65,0.05);">
                                <h3 class="force-blue">> INQUIRY_SUBMISSION_FORM</h3>
                                <form id="vault-contact-form" onsubmit="handleFormSubmit(event)" style="display:flex; flex-direction:column; gap:15px;">
                                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                                        <input type="text" name="first_name" placeholder="FIRST_NAME" required class="form-input" maxlength="50">
                                        <input type="text" name="last_name" placeholder="LAST_NAME" required class="form-input" maxlength="50">
                                    </div>
                                    <input type="email" name="email" placeholder="EMAIL_ADDRESS" required class="form-input" maxlength="100" 
                                           pattern="^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$" 
                                           title="Please enter a valid email address (e.g., name@domain.com)">
                                    <input type="tel" id="phone-input" name="phone" placeholder="PHONE_NUMBER (10 DIGITS)" required class="form-input" 
                                           maxlength="10" minlength="10" pattern="[0-9]{10}" title="Please enter exactly 10 digits.">
                                    <textarea name="message" maxlength="1000" placeholder="MESSAGE_DETAILS" required class="form-input" style="min-height:100px;"></textarea>
                                    <button type="submit" class="submit-btn" style="background:var(--accent); color:black; font-weight:bold;">[ SEND_TRANSMISSION ]</button>
                                </form>
                            </div>
                        ` : ''}
                    </div>`;
                applyBlueBranding(content);
                setTimeout(() => applyBlueBranding(content), 150);
            } catch (e) { content.innerHTML = "<p class='force-blue'>[!] ERROR: DATA_LINK_SEVERED</p>"; }
        }

        async function loadLogs(folder, auto = false, btn = null) {
            const list = document.getElementById('log-list');
            const sidebar = document.getElementById('sidebar');
            const commentWrapper = document.getElementById('comment-wrapper');
            sidebar.style.display = folder === 'about' ? 'none' : 'block';
            commentWrapper.style.display = 'none';
            clearStage(`${folder.toUpperCase()}_CHANNEL`, "SELECT A LOG FROM THE DIRECTORY TO VIEW CONTENT.");
            document.querySelectorAll('.submit-btn').forEach(b => b.classList.remove('active'));
            if (btn) btn.classList.add('active');
            try {
                const r = await fetch(`https://api.github.com/repos/${repo}/contents/${folder}?t=${Date.now()}`);
                const files = await r.json();
                list.innerHTML = "";
                files.filter(f => f.name.endsWith('.md'))
                    .sort((a, b) => b.name.substring(0, 10).localeCompare(a.name.substring(0, 10)))
                    .forEach(f => {
                        const li = document.createElement('li');
                        li.style.listStyle = "none";
                        let displayName = f.name.replace('.md', '').toUpperCase().replace(/-/g, ' ').replace(/_/g, ' ');
                        const newTag = isNew(f.name) ? `<span class="blink" style="color:#ff0000; font-size:0.7em; font-weight:bold;">[NEW]</span> ` : "";
                        li.innerHTML = `${newTag}<a href="javascript:void(0)" onclick="loadPost('${f.path}')" class="log-link">> ${displayName}</a>`;
                        list.appendChild(li);
                    });
                if (folder === 'about') {
                    const firstFile = files.find(f => f.name.endsWith('.md'));
                    if (firstFile) loadPost(firstFile.path);
                }
            } catch (e) { list.innerHTML = "<li>[ SCAN_FAILED ]</li>"; }
        }

        async function runGlobalScan() {
            document.getElementById('sidebar').style.display = 'block';
            const list = document.getElementById('log-list');
            document.querySelectorAll('.submit-btn').forEach(b => b.classList.remove('active'));
            clearStage("SYSTEM_READY", "SELECT A DATA_CHANNEL OR SCAN FOR UPDATES.");
            list.innerHTML = '<li>[ GLOBAL_SCAN_ACTIVE... ]</li>';
            const folders = ['dispatch', 'gear', 'coord', 'table'];
            let recentFiles = [];
            for (const fld of folders) {
                try {
                    const r = await fetch(`https://api.github.com/repos/${repo}/contents/${fld}?t=${Date.now()}`);
                    const data = await r.json();
                    if (Array.isArray(data)) data.forEach(file => { if (file.name.endsWith('.md')) recentFiles.push(file); });
                } catch (err) {}
            }
            list.innerHTML = '';
            recentFiles.sort((a, b) => b.name.substring(0, 10).localeCompare(a.name.substring(0, 10)))
                .slice(0, 10)
                .forEach(f => {
                    const li = document.createElement('li');
                    li.style.listStyle = "none";
                    let displayName = f.name.replace('.md', '').toUpperCase().replace(/-/g, ' ').replace(/_/g, ' ');
                    const newTag = isNew(f.name) ? `<span class="blink" style="color:#ff0000; font-size:0.7em; font-weight:bold;">[NEW]</span> ` : "";
                    li.innerHTML = `${newTag}<a href="javascript:void(0)" onclick="loadPost('${f.path}')" class="log-link">> ${displayName}</a>`;
                    list.appendChild(li);
                });
        }

        document.getElementById('theme-toggle').addEventListener('click', () => {
            const current = document.documentElement.getAttribute('data-theme');
            const target = current === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', target);
            localStorage.setItem('theme', target);
        });

        setInterval(() => { 
            const clock = document.getElementById('stardate');
            if(clock) clock.innerText = new Date().toLocaleTimeString(); 
        }, 1000);

        window.onload = () => {
            if(localStorage.getItem('theme') === 'light') document.documentElement.setAttribute('data-theme', 'light');
            
            // DEEP LINK LISTENER
            const urlParams = new URLSearchParams(window.location.search);
            const logPath = urlParams.get('log'); // Usage: v64otd.com/?log=gear/filename.md
            
            if (logPath) {
                // Load the specific post if a path is provided in the URL
                loadPost(logPath);
                // Also load the sidebar for that category so the UI looks correct
                const category = logPath.split('/')[0];
                if (category) {
                    loadLogs(category);
                }
            } else {
                runGlobalScan();
            }
        };
    </script>
</body>
</html>
