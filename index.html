<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Old Texas Dude | The Vault</title>
    
    <meta name="description" content="The Culinary and Technical Vault of Old Texas Dude: Featuring personal heritage recipes, culinary destinations, and field reports on gear and travel coordinates.">
    <meta name="keywords" content="Old Texas Dude, Product Evaluations, Independent Reviews, Travel Destinations, Heritage Recipes, Field Reports">
    <meta name="author" content="Old Texas Dude">

    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js"></script>
</head>
<body id="personal-identity">
    <div class="terminal-overlay"></div>
    <div class="container">
        <header>
            <div class="warning-banner" style="text-align: center; margin-bottom: 20px;">
                <span class="blink" style="font-weight: bold; color: var(--accent);">!! WARNING: !!</span><br>
                <span style="font-size: 0.85em;">UNFILTERED OPINIONS AHEAD</span>
                <div style="margin-top:15px;">
                    <button id="theme-toggle" class="submit-btn" style="font-size:0.75em;">VISUAL_MODE</button>
                </div>
            </div>
        </header>

        <section class="hero-container">
            <img src="telescope2.png" alt="The Watch Tower">
            <div class="hero-text-block">
                <h1 class="main-title"><span class="typewriter">The Watch Tower</span></h1>
                <span class="by-line">by</span>
                <h1 class="main-title"><span class="typewriter delay-type">Old Texas Dude&trade;</span></h1>
            </div>
        </section>

        <nav class="vault-nav-container">
            <div class="primary-nav" style="margin-bottom: 15px; width: 100%;">
                <button id="btn-about" onclick="loadLogs('about', false, this)" class="submit-btn" style="width: 100%; padding: 12px; border-color: var(--accent); color: var(--accent); font-weight: bold; font-size: 1rem;">
                    ABOUT: OLD TEXAS DUDE
                </button>
            </div>

            <div class="secondary-filters">
                <button id="btn-dispatch" onclick="loadLogs('dispatch', false, this)" class="submit-btn">THE DISPATCH</button>
                <button id="btn-transit" onclick="loadLogs('coord', false, this)" class="submit-btn">TRANSIT</button>
                <button id="btn-gear" onclick="loadLogs('gear', false, this)" class="submit-btn">GEAR</button>
                <button id="btn-coord" onclick="loadLogs('coord', false, this)" class="submit-btn">COORD</button>
                <button id="btn-table" onclick="loadLogs('table', false, this)" class="submit-btn">THE TABLE</button>
            </div>
        </nav>

        <main class="vault-layout">
            <aside id="sidebar" class="log-directory">
                <button id="re-scan-btn" onclick="runGlobalScan()" class="submit-btn" style="width:100%; margin-bottom:20px; color:var(--secondary); border-color:var(--secondary);">RESCAN</button>
                <h3>> LOG_DIRECTORY</h3>
                <ul id="log-list" class="file-list"><li>[ INITIALIZING_SCAN... ]</li></ul>
            </aside>

            <section class="log-display">
                <article id="content" class="blog-post">
                    <div id="startup-message" style="text-align: center; padding: 40px;">
                        <h2 class="force-blue">> SYSTEM_READY</h2>
                        <p style="font-size: 0.8rem; opacity: 0.7;">SELECT A DATA_CHANNEL OR SCAN FOR UPDATES.</p>
                    </div>
                </article>
                <div id="comment-wrapper" class="comment-module" style="display:none; margin-top:40px; border-top:1px solid var(--border); padding-top:20px;">
                    <script src="https://utteranc.es/client.js" repo="kdbush64-create/otd-vault" issue-term="pathname" theme="github-dark" crossorigin="anonymous" async></script>
                </div>
            </section>
        </main>

        <footer>
            <div style="text-align:center; margin-bottom:10px; font-size:0.7rem; color:var(--secondary);">
                SYSTEM_TIME: <span id="stardate"></span>
            </div>
            <p class="footer-tag blink">PERSONAL_THOUGHTS_V1.5 // NEON_MODULE_STABLE</p>
        </footer>
    </div>

    <script>
        const repo = "kdbush64-create/otd-vault";

        function clearStage(message = "CHANNEL_SELECTED") {
            const content = document.getElementById('content');
            content.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <h2 class="force-blue">> ${message}</h2>
                    <p style="font-size: 0.8rem; opacity: 0.7;">INITIALIZING DATA STREAM...</p>
                </div>`;
        }

        function applyBlueBranding(container) {
            const elements = container.querySelectorAll('p, li, div, h1, h2, h3, h4, strong, b');
            elements.forEach(el => {
                let html = el.innerHTML;
                if (html.includes('**')) {
                    el.innerHTML = html.replace(/\*\*(.*?)\*\*/g, '<span class="force-blue">$1</span>');
                }
            });
        }

        async function loadPost(path) {
            const content = document.getElementById('content');
            const commentWrapper = document.getElementById('comment-wrapper');
            
            content.innerHTML = "<p class='blink' style='color:var(--accent)'>EXTRACTING_DATA_STREAM...</p>";
            
            try {
                const r = await fetch(`https://raw.githubusercontent.com/${repo}/main/${path}?t=${Date.now()}`);
                let txt = await r.text();
                
                // Only show comments if NOT in the "about" folder
                if (path.toLowerCase().includes('about/')) {
                    commentWrapper.style.display = 'none';
                } else {
                    commentWrapper.style.display = 'block';
                }

                let cleanName = path.split('/').pop().replace('.md', '').toUpperCase().replace(/-/g, ' ').replace(/_/g, ' ');
                document.title = `${cleanName} | OTD Vault`;

                if (txt.startsWith('---')) {
                    txt = txt.split('---').slice(2).join('---').trim();
                }

                marked.setOptions({ gfm: true, breaks: true });
                const isAbout = path.toLowerCase().includes('the-man') || path.toLowerCase().includes('the_man');

                content.innerHTML = `
                    <div class="blog-post-body">
                        <div>${marked.parse(txt)}</div>
                        ${isAbout ? `
                            <div id="contact-terminal" style="margin-top:40px; border:1px solid var(--accent); padding:20px; background: rgba(0,255,65,0.05);">
                                <h3 class="force-blue">> INQUIRY_SUBMISSION_FORM</h3>
                                <form action="https://formspree.io/f/YOUR_FORMSPREE_ID_HERE" method="POST" style="display:flex; flex-direction:column; gap:15px;">
                                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                                        <input type="text" name="first_name" placeholder="FIRST_NAME" required class="submit-btn" style="text-align:left; background:black;">
                                        <input type="text" name="last_name" placeholder="LAST_NAME" required class="submit-btn" style="text-align:left; background:black;">
                                    </div>
                                    <input type="email" name="email" placeholder="EMAIL_ADDRESS" required class="submit-btn" style="text-align:left; background:black;">
                                    <input type="tel" name="phone" placeholder="PHONE_NUMBER" class="submit-btn" style="text-align:left; background:black;">
                                    <textarea name="message" maxlength="1000" placeholder="MESSAGE_DETAILS (MAX 1000 CHARS)" required class="submit-btn" style="text-align:left; background:black; min-height:100px; font-family:monospace;"></textarea>
                                    <button type="submit" class="submit-btn" style="background:var(--accent); color:black; font-weight:bold;">[ SEND_TRANSMISSION ]</button>
                                </form>
                            </div>
                        ` : ''}
                    </div>`;
                
                applyBlueBranding(content);
                setTimeout(() => applyBlueBranding(content), 150);
            } catch (e) { 
                content.innerHTML = "<p class='force-blue'>[!] ERROR: DATA_LINK_SEVERED</p>"; 
                commentWrapper.style.display = 'none';
            }
        }

        async function loadLogs(folder, auto = false, btn = null) {
            const list = document.getElementById('log-list');
            const sidebar = document.getElementById('sidebar');
            const commentWrapper = document.getElementById('comment-wrapper');
            const isTransitButton = btn && btn.id === 'btn-transit';
            const isCoordButton = btn && btn.id === 'btn-coord';
            
            if (folder === 'about') {
                sidebar.style.display = 'none';
                commentWrapper.style.display = 'none';
            } else {
                sidebar.style.display = 'block';
                // Note: commentWrapper stays hidden until loadPost is called
                commentWrapper.style.display = 'none'; 
            }

            clearStage(`${isTransitButton ? 'TRANSIT' : folder.toUpperCase()}_CHANNEL`);
            document.querySelectorAll('.submit-btn').forEach(b => b.classList.remove('active'));
            if (btn) btn.classList.add('active');
            
            list.innerHTML = "<li>[ SCANNING_CHANNEL... ]</li>";
            try {
                const r = await fetch(`https://api.github.com/repos/${repo}/contents/${folder}?t=${Date.now()}`);
                const files = await r.json();
                
                if (!Array.isArray(files) || files.length === 0) {
                    list.innerHTML = "<li>[ NO_FILES_FOUND ]</li>";
                    return;
                }

                if (folder === 'about') {
                    const firstFile = files.find(f => f.name.endsWith('.md'));
                    if (firstFile) loadPost(firstFile.path);
                }

                list.innerHTML = "";
                files.filter(f => f.name.endsWith('.md'))
                .sort((a,b) => b.name.localeCompare(a.name))
                .forEach(f => {
                    const name = f.name.toLowerCase();
                    if (isTransitButton && !name.includes('transit')) return;
                    if (isCoordButton && name.includes('transit')) return;
                    
                    const li = document.createElement('li');
                    li.style.listStyle = "none";
                    let displayName = f.name.replace('.md', '').toUpperCase().replace(/-/g, ' ').replace(/_/g, ' ');
                    li.innerHTML = `<a href="javascript:void(0)" onclick="loadPost('${f.path}')" class="log-link">> ${displayName}</a>`;
                    list.appendChild(li);
                });
            } catch (e) { list.innerHTML = "<li>[ SCAN_FAILED ]</li>"; }
        }

        async function runGlobalScan() {
            document.getElementById('sidebar').style.display = 'block';
            document.getElementById('comment-wrapper').style.display = 'none'; 
            const list = document.getElementById('log-list');
            clearStage("SYSTEM_READY");
            list.innerHTML = '<li>[ GLOBAL_SCAN_ACTIVE... ]</li>';
            const folders = ['dispatch', 'gear', 'coord', 'table'];
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
            let recentFiles = [];

            for (const fld of folders) {
                try {
                    const r = await fetch(`https://api.github.com/repos/${repo}/contents/${fld}?t=${Date.now()}`);
                    const data = await r.json();
                    if (Array.isArray(data)) {
                        data.forEach(file => {
                            if (file.name.endsWith('.md')) {
                                const match = file.name.match(/\d{4}-\d.md/);
                                // Simplified recent check for the scan
                                recentFiles.push(file);
                            }
                        });
                    }
                } catch (err) {}
            }

            if (recentFiles.length > 0) {
                list.innerHTML = '';
                // Limit to most recent 10 for the global scan
                recentFiles.sort((a, b) => b.name.localeCompare(a.name)).slice(0, 10).forEach(f => {
                    const li = document.createElement('li');
                    li.style.listStyle = "none";
                    let displayName = f.name.replace('.md', '').toUpperCase().replace(/-/g, ' ').replace(/_/g, ' ');
                    li.innerHTML = `<span class="blink" style="color:#ff0000; font-size:0.7em; font-weight:bold;">[NEW]</span> <a href="javascript:void(0)" onclick="loadPost('${f.path}')" class="log-link">> ${displayName}</a>`;
                    list.appendChild(li);
                });
            } else {
                list.innerHTML = '<li>[ NO_RECENT_ACTIVITY ]</li>';
            }
        }

        document.getElementById('theme-toggle').addEventListener('click', () => {
            const current = document.documentElement.getAttribute('data-theme');
            const target = current === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', target);
            localStorage.setItem('theme', target);
        });

        setInterval(() => { 
            const clock = document.getElementById('stardate');
            if(clock) clock.innerText = new Date().toLocaleTimeString(); 
        }, 1000);

        window.onload = () => {
            if(localStorage.getItem('theme') === 'light') document.documentElement.setAttribute('data-theme', 'light');
            runGlobalScan();
        };
    </script>
</body>
</html>
