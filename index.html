<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Old Texas Dude | The Vault</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js"></script>
</head>

<body id="personal-identity">
    <div class="terminal-overlay"></div>
    <div class="container">

        <header>
            <div class="warning-banner">
                <span class="blink" style="font-weight: bold; color: var(--accent);">!! WARNING: !!</span> <br> 
                <span style="font-size: 0.85em; letter-spacing: 1px; display: block; margin-bottom: 12px;">UNFILTERED OPINIONS AHEAD</span>
                
                <div style="border-top: 1px dashed var(--border); padding-top: 12px; margin-top: 10px;">
                    <span class="system-status">
                        [ VIEW_MODE: <span id="mode-text">NATIVE_TERMINAL</span> ]<br>
                        <span id="instruction-text">TOGGLE VISUAL_MODE FOR HIGH-VISIBILITY READING</span>
                    </span>
                    <button id="theme-toggle" class="submit-btn" style="font-size: 0.75em; padding: 6px 16px; margin-top: 15px;">VISUAL_MODE</button>
                </div>
            </div>
        </header>

        <section class="hero-container">
            <img src="telescope-clean.jpg" alt="The Watch Tower">
            <div class="hero-text-block">
                <h1 class="main-title"><span class="typewriter">The Watch Tower</span></h1>
                <span class="by-line">by</span>
                <h1 class="main-title"><span class="typewriter delay-type">Old Texas Dude&trade;</span></h1>
            </div>
        </section>

        <nav class="vault-nav-container">
            <div class="nav-group">
                <h3 class="nav-label">[ PRIMARY_COMMAND ]</h3>
                <button id="btn-watch_tower" onclick="loadLogs('watch_tower', true, this)" class="submit-btn primary-gate">
                    ACCESS_WATCH_TOWER
                </button>
            </div>

            <div class="nav-group">
                <h3 class="nav-label">[ DATA_CHANNELS ]</h3>
                <div class="secondary-filters">
                    <button id="btn-chow" onclick="loadLogs('chow', true, this)" class="submit-btn">CHOW</button>
                    <button id="btn-coord" onclick="loadLogs('coord', true, this)" class="submit-btn">COORD</button>
                    <button id="btn-gear" onclick="loadLogs('gear', true, this)" class="submit-btn">GEAR</button>
                </div>
            </div>
        </nav>

        <main class="vault-layout">
            <section class="log-display">
                <article id="content" class="blog-post">
                    <p class="blink" style="color: var(--accent);">> ESTABLISHING_UPLINK...</p>
                </article>
                <div class="comment-module">
                    <script src="https://utteranc.es/client.js" repo="kdbush64-create/otd-vault" issue-term="pathname" theme="preferred-color-scheme" crossorigin="anonymous" async></script>
                </div>
            </section>

            <aside class="log-directory">
                <h3>> LOG_DIRECTORY</h3>
                <p class="archive-note">[ AUTO_ARCHIVE: ACTIVE (>7 DAYS) ]</p>
                <ul class="file-list" id="log-list"><li>[ SCANNING_VAULT... ]</li></ul>
                <button id="load-more-btn" onclick="showAllLogs()" class="submit-btn" style="display:none; width: 100%; margin-top: 10px;">
                    [ SHOW_FULL_ARCHIVE ]
                </button>
                
                <div class="surveillance-wrapper">
                    <h3>> VISUAL_UPLINK</h3>
                    <div class="feed-header"><span class="blink">● REC</span><span id="stardate"></span></div>
                    <div class="feed-container">
                        <behold-widget feed-id="9Bgo9cQPytudmTM356WP"></behold-widget>
                    </div>
                </div>
            </aside>
        </main>

        <footer>
            <div class="footer-grid">
                <a href="javascript:void(0)" onclick="loadPost('gear/gear-policy.md')" class="footer-link">[ GEAR_POLICY ]</a>
                <a href="mailto:your-email@example.com" class="footer-link">[ SEND_FEEDBACK ]</a>
            </div>
            <p class="footer-tag blink">PERSONAL_THOUGHTS_V1.5 // NEON_MODULE_STABLE</p>
        </footer>
    </div>

    <script>
        const repo = "kdbush64-create/otd-vault";
        const DISPLAY_LIMIT = 10;

        // Theme Logic
        const toggleBtn = document.getElementById('theme-toggle');
        const modeText = document.getElementById('mode-text');
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'light') document.documentElement.setAttribute('data-theme', 'light');

        toggleBtn.addEventListener('click', () => {
            let theme = document.documentElement.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            if (modeText) modeText.innerText = (theme === 'light') ? 'FIELD_EXTRACT' : 'NATIVE_TERMINAL';
        });

        function updateClock() {
            const clock = document.getElementById('stardate');
            if(clock) clock.innerText = new Date().toLocaleTimeString();
        }
        setInterval(updateClock, 1000);

        function highlightLogLabels(container) {
            const blueKeywords = ["SUMMARY:", "OBSERVATION:", "WATCH_TOWER REPORT", "Old Texas Dude™"];
            const greenKeywords = ["STATUS:", "THE_VERDICT:", "RATING:"];
            
            const targets = container.querySelectorAll('h1, h2, h3, strong, li, p, span');
            
            targets.forEach(el => {
                let html = el.innerHTML;
                let changed = false;

                blueKeywords.forEach(k => { 
                    if(html.includes(k) && !html.includes('highlight-blue')) {
                        const regex = new RegExp(`(${k})`, 'g');
                        html = html.replace(regex, `<span class="highlight-blue">$1</span>`); 
                        changed = true;
                    }
                });

                greenKeywords.forEach(k => { 
                    if(html.includes(k) && !html.includes('highlight-green')) {
                        const regex = new RegExp(`(${k})`, 'g');
                        html = html.replace(regex, `<span class="highlight-green">$1</span>`); 
                        changed = true;
                    }
                });

                if (changed) el.innerHTML = html;
            });
        }

        async function loadPost(filePath, isManualClick = false) {
            const contentArea = document.getElementById('content');
            contentArea.innerHTML = "<p class='blink' style='color: var(--accent);'>EXTRACTING_DATA_STREAM...</p>";
            window.location.hash = filePath; 

            try {
                const response = await fetch(`https://raw.githubusercontent.com/${repo}/main/${filePath}?t=${new Date().getTime()}`);
                if (!response.ok) throw new Error('File not found');

                const text = await response.text();
                let cleanMarkdown = text;
                if (text.startsWith('---')) {
                    cleanMarkdown = text.split('---').slice(2).join('---').trim();
                }
                
                let finalHTML = marked.parse(cleanMarkdown);
                finalHTML = finalHTML.replace(/WATCH_TOWER_REPORT/g, 'WATCH_TOWER REPORT');

                contentArea.innerHTML = `<div class="blog-post-body">${finalHTML}</div>`;
                
                setTimeout(() => highlightLogLabels(contentArea), 50);
                
                if (isManualClick) {
                    const scrollTarget = window.innerWidth < 850 ? 800 : 400;
                    window.scrollTo({ top: scrollTarget, behavior: 'smooth' });
                }
            } catch (err) { 
                console.error(err);
                contentArea.innerHTML = "<p>[!] ERROR: LINK_SEVERED - FILE_NOT_FOUND</p>"; 
            }
        }

        async function loadLogs(folder, autoLoadFirst = false, btn = null) {
            const list = document.getElementById('log-list');
            document.querySelectorAll('.submit-btn').forEach(b => b.classList.remove('active'));
            if (btn) btn.classList.add('active');
            list.innerHTML = '<li>[ SCANNING... ]</li>';

            try {
                // The ?t= timestamp forces GitHub to show your newly renamed file immediately
                const response = await fetch(`https://api.github.com/repos/${repo}/contents/${folder}?t=${new Date().getTime()}`);
                const files = await response.json();
                
                // Filter for .md files and sort alphabetically (dates will float to the top)
                const mdFiles = files.filter(f => f.name.toLowerCase().endsWith('.md')).sort((a, b) => b.name.localeCompare(a.name));
                
                list.innerHTML = '';
                
                if (mdFiles.length === 0) {
                    list.innerHTML = '<li>[ NO_LOGS_FOUND ]</li>';
                    return;
                }

                const sevenDaysAgo = new Date();
                sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);

                mdFiles.forEach((f, i) => {
                    const li = document.createElement('li');
                    if (i >= DISPLAY_LIMIT) { 
                        li.style.display = "none"; 
                        li.classList.add('older-log'); 
                    }
                    
                    // Check for [NEW] badge logic
                    const dateMatch = f.name.match(/\d{4}-\d{2}-\d{2}/);
                    const isNew = dateMatch && new Date(dateMatch[0]) >= sevenDaysAgo;
                    const badge = isNew ? `<span class="blink" style="color:#ff0000; font-size:0.7em; font-weight:bold;">[NEW] </span>` : '';
                    
                    // Cleanup display name: remove .md and turn dashes to spaces
                    let displayName = f.name.replace(/\.[^/.]+$/, "").toUpperCase().replace(/-/g, ' ');
                    
                    // Use f.path to ensure the link points to the correct folder
                    li.innerHTML = `${badge}<a href="javascript:void(0)" class="log-link" onclick="loadPost('${f.path}', true)">> ${displayName}</a>`;
                    list.appendChild(li);
                });

                document.getElementById('load-more-btn').style.display = mdFiles.length > DISPLAY_LIMIT ? "block" : "none";
                
                if (autoLoadFirst && mdFiles.length > 0) loadPost(mdFiles[0].path);

            } catch (e) { 
                console.error("Scan error:", e);
                list.innerHTML = "<li>[ SCAN_FAILED ]</li>"; 
            }
        }

        function showAllLogs() { 
            document.querySelectorAll('.older-log').forEach(log => log.style.display = "block"); 
            document.getElementById('load-more-btn').style.display = "none"; 
        }

        window.addEventListener('DOMContentLoaded', async () => {
    const hash = window.location.hash.replace('#', '');
    
    // If a user clicks a specific link, go straight there
    if (hash) {
        loadLogs(hash.split('/')[0], false).then(() => loadPost(hash));
    } else {
        // Option B: Scan all folders to find the absolute newest post for the landing page
        const folders = ['watch_tower', 'chow', 'gear', 'coord'];
        let newestFile = null;
        let newestDate = "";

        try {
            const scanPromises = folders.map(folder => 
                fetch(`https://api.github.com/repos/${repo}/contents/${folder}?t=${new Date().getTime()}`)
                .then(res => res.json())
                .catch(() => []) // Ignore empty/missing folders
            );

            const results = await Promise.all(scanPromises);
            
            results.flat().forEach(f => {
                if (f.name && f.name.endsWith('.md')) {
                    // Extract date from YYYY-MM-DD format
                    const dateMatch = f.name.match(/\d{4}-\d{2}-\d{2}/);
                    const fileDate = dateMatch ? dateMatch[0] : "0000-00-00";
                    
                    if (fileDate > newestDate) {
                        newestDate = fileDate;
                        newestFile = f;
                    }
                }
            });

            if (newestFile) {
                // Determine which folder the newest file belongs to
                const folderOfFile = newestFile.path.split('/')[0];
                const navBtn = document.getElementById(`btn-${folderOfFile}`);
                
                // Load the list for that folder and display the post
                loadLogs(folderOfFile, true, navBtn);
            } else {
                // Fallback if no dated files are found
                loadLogs('watch_tower', true, document.getElementById('btn-watch_tower'));
            }
        } catch (err) {
            console.error("Global scan failed", err);
            loadLogs('watch_tower', true);
        }
    }
});

        (() => { const d=document,s=d.createElement("script");s.type="module"; s.src="https://w.behold.so/widget.js";d.head.append(s); })();
    </script>
</body>
</html>


